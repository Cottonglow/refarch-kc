



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.0.1">
    
    
      
        <title>Run on IBM Cloud Kubernetes Services - Container Shipment EDA reference implementation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.982221ab.css">
      
      
    
    
      <script src="../../assets/javascripts/modernizr.1f0bcf2b.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../extra.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#iks-deployment" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="Container Shipment EDA reference implementation" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Container Shipment EDA reference implementation
            </span>
            <span class="md-header-nav__topic">
              Run on IBM Cloud Kubernetes Services
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/ibm-cloud-architecture/refarch-kc/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="Container Shipment EDA reference implementation" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Container Shipment EDA reference implementation
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/ibm-cloud-architecture/refarch-kc/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Welcome" class="md-nav__link">
      Welcome
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Business problem statement
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Business problem statement
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../introduction/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../analysis/readme/" title="Event storming analysis" class="md-nav__link">
      Event storming analysis
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../design/readme/" title="Design considerations and microservice identifications" class="md-nav__link">
      Design considerations and microservice identifications
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../design/architecture/" title="Architecture" class="md-nav__link">
      Architecture
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Development practices
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Development practices
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-kc-order-ms" title="Order microservice with CQRS and Event Sourcing" class="md-nav__link">
      Order microservice with CQRS and Event Sourcing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-kc-container-ms/kstreams/" title="Container microservice with event sourcing and Kafka streams" class="md-nav__link">
      Container microservice with event sourcing and Kafka streams
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-kc-container-ms/flask" title="Container microservice with Python" class="md-nav__link">
      Container microservice with Python
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-kc-container-ms/springboot" title="Container microservice with Springboot - Spring Kafka and PostgreSQL" class="md-nav__link">
      Container microservice with Springboot - Spring Kafka and PostgreSQL
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../reposlist/" title="Related repositories" class="md-nav__link">
      Related repositories
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7" checked>
    
    <label class="md-nav__link" for="nav-7">
      Build and run
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Build and run
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../local/" title="Run locally with Docker Compose" class="md-nav__link">
      Run locally with Docker Compose
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Run on IBM Cloud Kubernetes Services
      </label>
    
    <a href="./" title="Run on IBM Cloud Kubernetes Services" class="md-nav__link md-nav__link--active">
      Run on IBM Cloud Kubernetes Services
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prepare-ibm-cloud-services-to-run-the-solution" title="Prepare IBM Cloud Services to run the solution" class="md-nav__link">
    Prepare IBM Cloud Services to run the solution
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pre-requisites" title="Pre-requisites" class="md-nav__link">
    Pre-requisites
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#define-an-image-private-repository" title="Define an image private repository" class="md-nav__link">
    Define an image private repository
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kubernetes-cluster-service" title="Kubernetes Cluster Service" class="md-nav__link">
    Kubernetes Cluster Service
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#event-streams-service-on-ibm-cloud" title="Event Streams Service on IBM Cloud" class="md-nav__link">
    Event Streams Service on IBM Cloud
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#streaming-analytics-service" title="Streaming Analytics Service" class="md-nav__link">
    Streaming Analytics Service
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-postgresql-service" title="The postgresql service" class="md-nav__link">
    The postgresql service
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run-the-solution-on-ibm-cloud-kubernetes-services" title="Run the solution on IBM Cloud Kubernetes Services" class="md-nav__link">
    Run the solution on IBM Cloud Kubernetes Services
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#event-stream-api-key" title="Event stream API key" class="md-nav__link">
    Event stream API key
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#postgresql-url-user-pwd-and-ca-certificate-as-secrets" title="Postgresql URL, User, PWD and CA certificate as secrets" class="md-nav__link">
    Postgresql URL, User, PWD and CA certificate as secrets
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#private-registry-token" title="Private Registry Token" class="md-nav__link">
    Private Registry Token
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#push-images" title="Push images" class="md-nav__link">
    Push images
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../icp/" title="Run on IBM Cloud Private" class="md-nav__link">
      Run on IBM Cloud Private
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../demo/readme/" title="Demonstration script" class="md-nav__link">
      Demonstration script
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../itg-tests/" title="Integration tests" class="md-nav__link">
      Integration tests
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#prepare-ibm-cloud-services-to-run-the-solution" title="Prepare IBM Cloud Services to run the solution" class="md-nav__link">
    Prepare IBM Cloud Services to run the solution
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pre-requisites" title="Pre-requisites" class="md-nav__link">
    Pre-requisites
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#define-an-image-private-repository" title="Define an image private repository" class="md-nav__link">
    Define an image private repository
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kubernetes-cluster-service" title="Kubernetes Cluster Service" class="md-nav__link">
    Kubernetes Cluster Service
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#event-streams-service-on-ibm-cloud" title="Event Streams Service on IBM Cloud" class="md-nav__link">
    Event Streams Service on IBM Cloud
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#streaming-analytics-service" title="Streaming Analytics Service" class="md-nav__link">
    Streaming Analytics Service
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-postgresql-service" title="The postgresql service" class="md-nav__link">
    The postgresql service
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run-the-solution-on-ibm-cloud-kubernetes-services" title="Run the solution on IBM Cloud Kubernetes Services" class="md-nav__link">
    Run the solution on IBM Cloud Kubernetes Services
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#event-stream-api-key" title="Event stream API key" class="md-nav__link">
    Event stream API key
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#postgresql-url-user-pwd-and-ca-certificate-as-secrets" title="Postgresql URL, User, PWD and CA certificate as secrets" class="md-nav__link">
    Postgresql URL, User, PWD and CA certificate as secrets
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#private-registry-token" title="Private Registry Token" class="md-nav__link">
    Private Registry Token
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#push-images" title="Push images" class="md-nav__link">
    Push images
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/ibm-cloud-architecture/refarch-kc/edit/master/docs/deployments/iks.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="iks-deployment">IKS Deployment</h1>
<p>In this document, you will learn how to deploy different microservices as part of the solution into IBM Cloud Kubernetes services, how to use IBM Event Streams and postgresql on IBM Cloud while running the solution locally, or only some services locally.
First you need to configure the needed services. </p>
<h2 id="prepare-ibm-cloud-services-to-run-the-solution">Prepare IBM Cloud Services to run the solution</h2>
<p>IBM Cloud offers a set of services to run part of your event driven solution. We are using the following services:</p>
<ul>
<li><a href="https://cloud.ibm.com/containers-kubernetes/catalog/cluster">Kubernetes Service</a></li>
<li><a href="https://cloud.ibm.com/catalog/services/streaming-analytics">Streaming Analytics Service</a> - As of now it is optional.</li>
<li><a href="https://cloud.ibm.com/catalog/services/event-streams">Event Streams</a></li>
<li>And if you want to use the container microservice with springboot and postgresql, you need <a href="https://cloud.ibm.com/catalog/services/databases-for-postgresql">postgresql</a></li>
</ul>
<p>At the high level the deployed solution on IKS, will look like in the following figure:</p>
<p><img alt="ic-deployment" src="../ic-deployment.png" />  </p>
<p>At least five microservices will be deployed (six if the container manager microservice is deployed) and three services created. You do not need to deploy <code>Streaming Analytics</code> service as it is still under construction.</p>
<p>Here is a dependency graph:</p>
<p><img alt="" src="../ms-dependencies.png" /></p>
<h2 id="pre-requisites">Pre-requisites</h2>
<ul>
<li>Create an account on <a href="https://cloud.ibm.com">IBM Cloud</a>.</li>
<li>Install the following CLIs:<ul>
<li><a href="https://docs.docker.com/install/">Docker CLI</a></li>
<li><a href="https://cloud.ibm.com/docs/cli/reference/ibmcloud/download_cli.html#install_use">IBM Cloud CLI</a></li>
<li><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">Kubernetes CLI</a></li>
<li>IBM Cloud Kubernetes Service <a href="https://cloud.ibm.com/docs/cli/reference/ibmcloud/extend_cli.html#plug-ins">plug-in</a> using the following command:</li>
</ul>
</li>
</ul>
<pre><code>ibmcloud plugin install container-service -r Bluemix
</code></pre>

<ul>
<li>Install IBM Cloud Container Registry CLI plug-in, using the command:</li>
</ul>
<pre><code>ibmcloud plugin install container-registry -r Bluemix
</code></pre>

<p>The following diagram illustrates the command lines interface and how they interact with IBM Cloud components:</p>
<p><img alt="" src="../ic-cli-comp.png" /></p>
<p>Each helm chart to deploy each component of the solution uses the private repository like: <code>us.icr.io/ibmcaseeda/</code>. As it is recommended to use your own private image repository, we are presenting a quick summary of what to do to define your own private registry in the next section.</p>
<h2 id="define-an-image-private-repository">Define an image private repository</h2>
<p>Use the <a href="https://cloud.ibm.com/containers-kubernetes/catalog/registry">docker container image private registry</a> to push your images and then deploy them to IBM Kubernetes Service. When deploying enterprise application it is strongly recommended to use private registry to protect your images from being used and changed by unauthorized users. Private registries must be set up by the cluster administrator to ensure that the credentials to access the private registry are available to the cluster users. </p>
<p>In the IBM Cloud Catalog, use the <code>Containers</code> category and <code>Container Registry</code> tile. Create the repository with the <code>create</code> button. You can share a repository between multi IKS clusters within the same region.</p>
<p>Once you access your registry, create a namespace for your solution. We used <code>ibmcaseeda</code> name. </p>
<p>*The namespace can also be created with the command: </p>
<pre><code>ibmcloud cr namespace-add ibmcaseeda
</code></pre>

<p>Here is a screen shot of the created image repository:</p>
<p><img alt="" src="../iks-registry-ns.png" /></p>
<p>We will use this namespace when tagging the docker images for our microservices. Here is an example of tagging:</p>
<pre><code class="shell">docker tag ibmcase/kc-ui us.icr.io/ibmcaseeda/kc-ui:latest
</code></pre>

<p>To see the images in your private registry you can use the user interface at <a href="https://cloud.ibm.com/containers-kubernetes/registry/main/private">https://cloud.ibm.com/containers-kubernetes/registry/main/private</a> or the command: </p>
<pre><code>ibmcloud cr image-list
</code></pre>

<p>But first let add a kubernetes cluster.</p>
<h2 id="kubernetes-cluster-service">Kubernetes Cluster Service</h2>
<p>If you need to know more about kubernetes, read the <a href="https://kubernetes.io/docs/tutorials/kubernetes-basics/">basic concepts here</a>.</p>
<p>To create the cluster follow <a href="https://console.bluemix.net/docs/containers/cs_tutorials.html#cs_cluster_tutorial">this tutorial</a>.</p>
<p>Here is an image of our cluster, with three nodes and the smallest possible configuration:</p>
<p><img alt="" src="../iks-cluster.png" /> </p>
<p>To access to the cluster use the following commands:</p>
<ul>
<li>Login to IBM Cloud. Do not need to be done each time.</li>
</ul>
<pre><code class="sh">ibmcloud login -a https://api.us-east.bluemix.net
</code></pre>

<ul>
<li>Target the IBM Cloud Container Service region in which you want to work.</li>
</ul>
<pre><code>ibmcloud ks region-set us-east
</code></pre>

<ul>
<li>You may need to update the CLI, as it changes quite often</li>
</ul>
<pre><code>ibmcloud plugin update container-service
</code></pre>

<ul>
<li>Set the KUBECONFIG environment variable.</li>
</ul>
<pre><code>export KUBECONFIG=/Users/$USER/.bluemix/plugins/container-service/clusters/fabio-wdc-07/kube-config-wdc07-fabio-wdc-07.yml
</code></pre>

<ul>
<li>Verify you have access to your cluster by listing the node:</li>
</ul>
<pre><code>kubectl get nodes
</code></pre>

<p>To set the cluster config to your cluster use: </p>
<pre><code>ibmcloud ks cluster-config &lt;cluster_name_or_ID&gt;
</code></pre>

<p>As it is recommended to ilosate your deployment from kubernetes default setting, create a namespace that can be the same as the container registry namespace name or something else. Below we create the browncompute namespace: </p>
<pre><code>kubectl create namespace browncompute
</code></pre>

<h2 id="event-streams-service-on-ibm-cloud">Event Streams Service on IBM Cloud</h2>
<p>To provision your service, go to the IBM Cloud Catalog and search for <code>Event Streams</code>. It is in the <em>Integration</em> category. Create the service and specify a name, a region, and a space. </p>
<ul>
<li>In the service credentials create new credentials to get the Kafka broker list, the admim URL and the api_key needed to authenticate the consumers or producers.</li>
</ul>
<p><img alt="" src="../IES-IC-credentials.png" /></p>
<p>We will use a kubernetes secret to define the api key (see detail <a href="#using-api-keys">in this section</a>)</p>
<ul>
<li>In the <em>Manage</em> panel add the topics needed for the solution. We need at least the following:</li>
</ul>
<p><img alt="" src="../IES-IC-topics.png" /> </p>
<h2 id="streaming-analytics-service">Streaming Analytics Service</h2>
<p>This service is only need when doing real time analytics with Streaming analytics service. </p>
<p>The documentation located <a href="https://github.com/ibm-cloud-architecture/refarch-kc-streams#application-development-and-deployment">here</a> describes how to configure the IBM Cloud based Streaming Analytics Service and how to build/deploy the example application. </p>
<h2 id="the-postgresql-service">The postgresql service</h2>
<p>The container manager microservice persists the Reefer container inventory in postgresql. To install the service follow the <a href="https://cloud.ibm.com/catalog/services/databases-for-postgresql">product documentation here</a>.</p>
<blockquote>
<p>If you do not plan to use this container manager service you do not need to create a Postgresql service.</p>
</blockquote>
<h2 id="run-the-solution-on-ibm-cloud-kubernetes-services">Run the solution on IBM Cloud Kubernetes Services</h2>
<h3 id="event-stream-api-key">Event stream API key</h3>
<p>The Event streams broker API key is needed to connect any deployed consumers or producers within kubernetes cluster to access the service in IBM Cloud. To avoid sharing security keys, we propose to define a kubernetes secret and deploy it to the IKS cluster.</p>
<ul>
<li>Define a Event Stream API key secret: to use Event Streams, we need to get the API key and configure a secret under the <code>browncompute</code> namespace.  </li>
</ul>
<pre><code class="shell">kubectl create secret generic eventstreams-apikey --from-literal=binding='&lt;replace with api key&gt;' -n browncompute
</code></pre>

<ul>
<li>Verify the secrets:</li>
</ul>
<pre><code>kubectl describe secrets -n browncompute
</code></pre>

<p>This secret is used by all the solution microservices which are using Kafka / Event Streams. The detail of how we use it with environment variables, is described in one of the project <a href="https://github.com/ibm-cloud-architecture/refarch-kc-ms/blob/master/fleet-ms/README.md#run-on-ibm-cloud-with-kubernetes-service">here.</a></p>
<h3 id="postgresql-url-user-pwd-and-ca-certificate-as-secrets">Postgresql URL, User, PWD and CA certificate as secrets</h3>
<p>Applying the same approach as above, copy the Postgresql URL as defined in the Postegresql service credential and execute the following command:</p>
<pre><code>kubectl create secret generic postgresql-url --from-literal=binding='&lt;replace with postgresql-url&gt;' -n browncompute
</code></pre>

<p>For the user:</p>
<pre><code>kubectl create secret generic postgresql-user --from-literal=binding='ibm_cloud_c...' -n browncompute
</code></pre>

<p>For the user password:</p>
<pre><code>kubectl create secret generic postgresql-pwd --from-literal=binding='&lt;password from the service credential&gt;.' -n browncompute
</code></pre>

<p>For the SSL certificate:</p>
<ul>
<li>Get the certificate using the name of the postgresql service:</li>
</ul>
<pre><code>ibmcloud cdb deployment-cacert $IC_POSTGRES_SERV &gt; postgresql.crt
</code></pre>

<ul>
<li>Then add it into an environment variable</li>
</ul>
<pre><code>export POSTGRESQL_CA_PEM=&quot;$(cat ./postgresql.crt)&quot;
</code></pre>

<ul>
<li>Then define a secret:</li>
</ul>
<pre><code>kubectl
create secret generic postgresql-ca-pem --from-literal=binding=&quot;$POSTGRESQL_CA_PEM&quot; -n browncompute
</code></pre>

<p>Now those variables and secrets are used in the deployment.yml file of the service that needs them. Like the Springboot container microservice. Here is an example of such settings:</p>
<pre><code></code></pre>

<h3 id="private-registry-token">Private Registry Token</h3>
<p>Each helm chart specifies the name of the docker image to load to create the containers / pods. The image name is from a private repository. To let kubernetes scheduler being able to access the registry, we need to define a secret to hold the security token. Here is an extract of a deployment yaml file referencing the <code>browncompute-registry-secret</code> secret.</p>
<pre><code class="yaml">spec:
      imagePullSecrets:
        - name: browncompute-registry-secret
      containers:
      - name: &quot;kc-ui&quot;
        image: &quot;us.icr.io/ibmcaseeda/kc-ui:latest&quot;
        imagePullPolicy: Always
</code></pre>

<p><em>Using secret is also mandatory when registry and clusters are not in the same region.</em></p>
<ul>
<li>Verify current secrets for a give namespace</li>
</ul>
<pre><code class="shell">kubectl describe secrets -n browncompute
</code></pre>

<ul>
<li>Get a security token: you can use permanent or renewable one:</li>
</ul>
<pre><code>ibmcloud cr token-add --description &quot;private registry secret for browncompute&quot; --non-expiring -q
</code></pre>

<ul>
<li>To list the token use the command</li>
</ul>
<pre><code>ibmcloud cr tokens
</code></pre>

<p>The result:</p>
<blockquote>
<p>TOKEN ID     READONLY   EXPIRY   DESCRIPTION <br />
 2b5ff00e-a..  true       0       token for somebody
 3dbf72eb-6..  true       0       private registry secret for browncompute</p>
</blockquote>
<ul>
<li>To get the token for a given token identifier</li>
</ul>
<pre><code>ibmcloud cr token-get cce5a800-...
</code></pre>

<ul>
<li>Define the secret to store the Event stream API key token information:</li>
</ul>
<pre><code>kubectl --namespace browncompute create secret docker-registry 
browncompute-registry-secret  --docker-server=&lt;registry_url&gt; --docker-username=token --docker-password=&lt;token_value&gt; --docker-email=&lt;docker_email&gt;
</code></pre>

<ul>
<li>Verify the secret   </li>
</ul>
<pre><code>kubectl get secrets -n browncompute  
</code></pre>

<p>You will see something like below.   </p>
<blockquote>
<table>
<thead>
<tr>
<th>NAME</th>
<th>TYPE</th>
<th>DATA</th>
<th>AGE</th>
</tr>
</thead>
<tbody>
<tr>
<td>browncompute-registry-secret</td>
<td>kubernetes.io/dockerconfigjson</td>
<td>1</td>
<td>2m</td>
</tr>
<tr>
<td>default-token-ggwl2</td>
<td>kubernetes.io/service-account-token</td>
<td>3</td>
<td>41m</td>
</tr>
<tr>
<td>eventstreams-apikey</td>
<td>Opaque</td>
<td>1</td>
<td>24m</td>
</tr>
</tbody>
</table>
</blockquote>
<p>Now for each microservice as part of the solution, we have defined helm chart and a script (deployHelm) to deploy to IKS. </p>
<p>This step is done one time only.
See also the product documentation <a href="https://console.bluemix.net/docs/containers/cs_dedicated_tokens.html">for more detail.</a></p>
<h3 id="push-images">Push images</h3>
<p>The following steps are done each time you want to deploy the solution to IKS. When using continuous deployment, these steps will be automated.</p>
<p>If you are not connected to IBM Cloud, do the following:   </p>
<pre><code class="sh">ibmcloud login -a https://api.us-east.bluemix.net
</code></pre>

<ul>
<li>Target the IBM Cloud Container Service region in which you want to work.   </li>
</ul>
<pre><code>ibmcloud ks region-set us-east   
</code></pre>

<ul>
<li>Set the KUBECONFIG environment variable.   </li>
</ul>
<pre><code>ibmcloud ks cluster-config fabio-wdc-07
</code></pre>

<pre><code>export KUBECONFIG=/Users/$USER/.bluemix/plugins/container-service/clusters/fabio-wdc-07/kube-config-wdc07-fabio-wdc-07.yml   
</code></pre>

<ul>
<li>Verify you have access to your cluster by listing the node:   </li>
</ul>
<pre><code>kubectl get nodes   
</code></pre>

<ul>
<li>login to the container registry</li>
</ul>
<pre><code>ibmcloud cr login
</code></pre>

<p>Then execute the script: <code>./scripts/pushToPrivate</code>  to deploy all component, or go to each repository and use the script <code>deployHelm</code>.</p>
<ul>
<li>Verify the images are in you private repo:</li>
</ul>
<pre><code>ibmcloud cr image-list
</code></pre>

<ul>
<li>Deploy the helm charts for each components using the <code>scripts/deployHelms</code>.   </li>
<li>Verify the deployments and pods:  </li>
</ul>
<pre><code>kubectl get deployments -n browncompute
</code></pre>

<blockquote>
<table>
<thead>
<tr>
<th>NAME</th>
<th>DESIRED</th>
<th>CURRENT</th>
<th>UP-TO-DATE</th>
<th>AVAILABLE</th>
<th>AGE</th>
</tr>
</thead>
<tbody>
<tr>
<td>fleetms-deployment</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>23h</td>
</tr>
<tr>
<td>kc-ui</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>18h</td>
</tr>
<tr>
<td>ordercommandms-deployment</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1d</td>
</tr>
<tr>
<td>orderqueryms-deployment</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>23h</td>
</tr>
<tr>
<td>voyagesms-deployment</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>19h</td>
</tr>
</tbody>
</table>
</blockquote>
<pre><code>kubectl get pods -n browncompute
</code></pre>

<blockquote>
<table>
<thead>
<tr>
<th>NAME</th>
<th>READY</th>
<th>STATUS</th>
<th>RESTARTS</th>
<th>AGE</th>
</tr>
</thead>
<tbody>
<tr>
<td>fleetms-deployment-564698b998-7pb2n</td>
<td>1/1</td>
<td>Running</td>
<td>0</td>
<td>23h</td>
</tr>
<tr>
<td>kc-ui-749d7df9db-jl6tv</td>
<td>1/1</td>
<td>Running</td>
<td>0</td>
<td>14h</td>
</tr>
<tr>
<td>ordercommandms-deployment-d6dc4fdc7-5wjtp</td>
<td>1/1</td>
<td>Running</td>
<td>0</td>
<td>1d</td>
</tr>
<tr>
<td>orderqueryms-deployment-5db96455f-6fqp5</td>
<td>1/1</td>
<td>Running</td>
<td>0</td>
<td>23h</td>
</tr>
<tr>
<td>voyagesms-deployment-6d7f8cdc8d-hnvq6</td>
<td>1/1</td>
<td>Running</td>
<td>0</td>
<td>19h</td>
</tr>
</tbody>
</table>
</blockquote>
<ul>
<li>You can perform a smoke test with the <code>scripts/smokeTestsIKS</code> or you can try to access some of the read APIs using the web browser. So first to get the public IP address of your cluster, go to the <code>Worker Nodes</code> view of the Clusters console.  Then to get the service exposed NodePort use <code>kubectl get services -n browncompute</code> and then get the port number mapped from one of the exposed ports (9080, 3010, 3000...):</li>
<li>fleetms: here is an example of URL : http://Public IP:31300/fleetms/fleets</li>
<li>UI: http://Public IP:31010/</li>
<li>Access the kubernetes console from your IKS deployment to see the deployment   </li>
</ul>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../local/" title="Run locally with Docker Compose" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Run locally with Docker Compose
              </span>
            </div>
          </a>
        
        
          <a href="../icp/" title="Run on IBM Cloud Private" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Run on IBM Cloud Private
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.b806dc00.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
    
  </body>
</html>