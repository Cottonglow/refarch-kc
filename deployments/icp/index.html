



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.0.1">
    
    
      
        <title>Run on IBM Cloud Private - Container Shipment EDA reference implementation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.982221ab.css">
      
      
    
    
      <script src="../../assets/javascripts/modernizr.1f0bcf2b.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../extra.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#prepare-ibm-cloud-private-to-run-the-solution" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="Container Shipment EDA reference implementation" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Container Shipment EDA reference implementation
            </span>
            <span class="md-header-nav__topic">
              Run on IBM Cloud Private
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/ibm-cloud-architecture/refarch-kc/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="Container Shipment EDA reference implementation" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Container Shipment EDA reference implementation
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/ibm-cloud-architecture/refarch-kc/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Business problem statement
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Business problem statement
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../introduction/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../analysis/readme/" title="Event storming analysis" class="md-nav__link">
      Event storming analysis
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../design/readme/" title="Design considerations and microservice identifications" class="md-nav__link">
      Design considerations and microservice identifications
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../design/architecture/" title="Architecture" class="md-nav__link">
      Architecture
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Development practices
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Development practices
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-kc-order-ms" title="Order microservice with CQRS and Event Sourcing" class="md-nav__link">
      Order microservice with CQRS and Event Sourcing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-kc-container-ms/kstreams/" title="Container microservice with event sourcing and Kafka streams" class="md-nav__link">
      Container microservice with event sourcing and Kafka streams
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-kc-container-ms/flask" title="Container microservice with Python" class="md-nav__link">
      Container microservice with Python
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-kc-container-ms/springboot" title="Container microservice with Springboot - Spring Kafka and PostgreSQL" class="md-nav__link">
      Container microservice with Springboot - Spring Kafka and PostgreSQL
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../reposlist/" title="Related repositories" class="md-nav__link">
      Related repositories
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7" checked>
    
    <label class="md-nav__link" for="nav-7">
      Deployments
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Deployments
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../local/" title="Run locally with Docker Compose" class="md-nav__link">
      Run locally with Docker Compose
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../minikube/" title="Run the complete solution in Minikube" class="md-nav__link">
      Run the complete solution in Minikube
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../iks/" title="Run on IBM Cloud Kubernetes Services" class="md-nav__link">
      Run on IBM Cloud Kubernetes Services
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Run on IBM Cloud Private
      </label>
    
    <a href="./" title="Run on IBM Cloud Private" class="md-nav__link md-nav__link--active">
      Run on IBM Cloud Private
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#install-event-streams-on-icp" title="Install Event Streams on ICP" class="md-nav__link">
    Install Event Streams on ICP
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-topics-and-secrets" title="Configure topics and secrets" class="md-nav__link">
    Configure topics and secrets
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#topics" title="Topics" class="md-nav__link">
    Topics
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api-key" title="API Key" class="md-nav__link">
    API Key
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#private-docker-registry" title="Private docker registry" class="md-nav__link">
    Private docker registry
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#namespace" title="Namespace" class="md-nav__link">
    Namespace
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#common-deployment-configuration" title="Common deployment configuration" class="md-nav__link">
    Common deployment configuration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#generic-deployment-process" title="Generic deployment process" class="md-nav__link">
    Generic deployment process
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#resilience" title="Resilience" class="md-nav__link">
    Resilience
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#monitoring" title="Monitoring" class="md-nav__link">
    Monitoring
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#code-considerations" title="Code considerations" class="md-nav__link">
    Code considerations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#troubleshouting" title="Troubleshouting" class="md-nav__link">
    Troubleshouting
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#no-resolvable-bootstrap-urls-given-in-bootstrapservers" title="No resolvable bootstrap urls given in bootstrap.servers" class="md-nav__link">
    No resolvable bootstrap urls given in bootstrap.servers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#failed-to-verify-broker-certificate-self-signed-certificate" title="Failed to verify broker certificate: self signed certificate" class="md-nav__link">
    Failed to verify broker certificate: self signed certificate
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ltpa-configuration-error-unable-to-create-or-read-ltpa-key-file-optibmwlpusrserversdefaultserverresourcessecurityltpakeys" title="LTPA configuration error. Unable to create or read LTPA key file: /opt/ibm/wlp/usr/servers/defaultServer/resources/security/ltpa.keys" class="md-nav__link">
    LTPA configuration error. Unable to create or read LTPA key file: /opt/ibm/wlp/usr/servers/defaultServer/resources/security/ltpa.keys
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="https://ibm-cloud-architecture.github.io/refarch-kc-container-ms/cicd" title="Example of ci/cd" class="md-nav__link">
      Example of ci/cd
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../security" title="Security" class="md-nav__link">
      Security
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../itg-tests/" title="Integration tests" class="md-nav__link">
      Integration tests
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../demo/readme/" title="Demonstration script" class="md-nav__link">
      Demonstration script
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#install-event-streams-on-icp" title="Install Event Streams on ICP" class="md-nav__link">
    Install Event Streams on ICP
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-topics-and-secrets" title="Configure topics and secrets" class="md-nav__link">
    Configure topics and secrets
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#topics" title="Topics" class="md-nav__link">
    Topics
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api-key" title="API Key" class="md-nav__link">
    API Key
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#private-docker-registry" title="Private docker registry" class="md-nav__link">
    Private docker registry
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#namespace" title="Namespace" class="md-nav__link">
    Namespace
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#common-deployment-configuration" title="Common deployment configuration" class="md-nav__link">
    Common deployment configuration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#generic-deployment-process" title="Generic deployment process" class="md-nav__link">
    Generic deployment process
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#resilience" title="Resilience" class="md-nav__link">
    Resilience
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#monitoring" title="Monitoring" class="md-nav__link">
    Monitoring
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#code-considerations" title="Code considerations" class="md-nav__link">
    Code considerations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#troubleshouting" title="Troubleshouting" class="md-nav__link">
    Troubleshouting
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#no-resolvable-bootstrap-urls-given-in-bootstrapservers" title="No resolvable bootstrap urls given in bootstrap.servers" class="md-nav__link">
    No resolvable bootstrap urls given in bootstrap.servers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#failed-to-verify-broker-certificate-self-signed-certificate" title="Failed to verify broker certificate: self signed certificate" class="md-nav__link">
    Failed to verify broker certificate: self signed certificate
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ltpa-configuration-error-unable-to-create-or-read-ltpa-key-file-optibmwlpusrserversdefaultserverresourcessecurityltpakeys" title="LTPA configuration error. Unable to create or read LTPA key file: /opt/ibm/wlp/usr/servers/defaultServer/resources/security/ltpa.keys" class="md-nav__link">
    LTPA configuration error. Unable to create or read LTPA key file: /opt/ibm/wlp/usr/servers/defaultServer/resources/security/ltpa.keys
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/ibm-cloud-architecture/refarch-kc/edit/master/docs/deployments/icp.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="prepare-ibm-cloud-private-to-run-the-solution">Prepare IBM Cloud Private to run the solution</h1>
<h2 id="install-event-streams-on-icp">Install Event Streams on ICP</h2>
<p>The installation is documented in the product documentation and in our <a href="https://ibm-cloud-architecture.github.io/refarch-eda/deployments/eventstreams/">own note here.</a></p>
<p>If not done go to the console 'toolbox tab' and download the Event Streams CLI and install it on top of ICP CLI using <code>cloudctl plugin install ./es-plugin</code>. Once installed, the IBM Event Streams CLI is invoked using <code>cloudctl es</code>.</p>
<h2 id="configure-topics-and-secrets">Configure topics and secrets</h2>
<p>To access the console, connect to the ICP console and select the deployment named something like: "*-es-ui-deploy" under the <code>streams</code> namespace. </p>
<h3 id="topics">Topics</h3>
<p>You can create the topics using the Event Streams console:</p>
<p><img alt="" src="../es-icp-topics.png" />  </p>
<p>or the use a set of commands like below, which are done for you in the script: <code>scripts/createLocalTopicsOnK8S.sh</code>.</p>
<pre><code class="shell"># get the name of the Kafka pod
$ kubectl get pods  -n streams | grep kafka | awk '{print $1;}'
&gt; rolling-streams-ibm-es-kafka-sts-0                              
rolling-streams-ibm-es-kafka-sts-1                               
rolling-streams-ibm-es-kafka-sts-2
# Then get the name of the zookeeper service:
$ kubectl get svc -n streams | grep zoo | awk '{print $1;}' | head -1
rolling-streams-ibm-es-zookeeper-fixed-ip-svc-0
# Then remote exec a shell on one of this broker to configure the topic - for example the &quot;orders&quot; topic
$ kubectl exec -n streams  -ti rolling-streams-ibm-es-kafka-sts-0   -- bash -c &quot;/opt/kafka/bin/kafka-topics.sh --create  --zookeeper $zooksvc:2181 --replication-factor 1 --partitions 1 --topic orders&quot;
</code></pre>

<h3 id="api-key">API Key</h3>
<p>Define an API key using the Event Stream Console. You can specify keys at the topic and consumer group levels or use a unique key for all topics and all consumer groups. Once you have the API key, define a <code>secret</code> named "eventstreams-apikey" with the command:</p>
<pre><code class="shell"> $ kubectl create secret generic eventstreams-apikey --from-literal=binding='&lt;api-key&gt;' -n greencompute
 $ kubectl describe secrets -n greencompute
</code></pre>

<p>This <code>eventstreams-apikey</code> secret will be used in the Helm chart settings and kubernetes deployment descriptor (see <a href="#code-considerations">this section</a> later in this article).</p>
<h2 id="private-docker-registry">Private docker registry</h2>
<p>When deploying ICP, operators can define a private registry that will be used to host the docker images created. To get the URL goes to the ICP console, then Manage &gt; Helm repositories (e.g. https://streamer.icp:8443/helm-repo/charts). </p>
<p><img alt="" src="../icp-repos.png" /></p>
<h2 id="namespace">Namespace</h2>
<p>Create a namespace to isolate the application within the solution. (e.g. greencompute)</p>
<pre><code class="shell">$ kubectl get namespaces
NAME           STATUS    AGE
cert-manager   Active    42d
default        Active    42d
greencompute   Active    18d
ibmcom         Active    42d
istio-system   Active    42d
kube-public    Active    42d
kube-system    Active    42d
platform       Active    42d
services       Active    42d
streams        Active    42d
</code></pre>

<h2 id="common-deployment-configuration">Common deployment configuration</h2>
<p>The repository name will be different if we deploy on IKS and ICP, also on IKs there is a password and api to access the registry that are persisted in a k8s secret. </p>
<p>When deploying kafka consumer it is important to assess the horizontal pod autoscaler settings and needs, as adding consumers will not address scalability if the number of partitions in the topic(s) to consume does not match the increase of consumers. So disable HPA by default. If you want to use HPA you also need to ensure that a metrics-server is running, then set the number of partition, and the <code>hpa.maxReplicas</code> to the number of partitions. </p>
<h2 id="generic-deployment-process">Generic deployment process</h2>
<ul>
<li>Login to the IBM Cloud private instance (execute <code>./scripts/icp-login.sh</code>)</li>
<li>Build or tag the docker image with the cluster name and namespace (e.g. <code>streamer.icp:8500/greencompute/kc-containerkstreams</code>)</li>
<li>Login to docker registry: <code>docker login streamer.icp:8500</code></li>
<li>Push the image to the repo: <code>docker push streamer.icp:8500/greencompute/&lt;imagename&gt;:&lt;version&gt;</code></li>
<li>Deploy the helm release: <code>helm install &lt;release&gt; --name &lt;releasename&gt; --namespace greencompute --tls</code></li>
</ul>
<p>Specific:</p>
<ul>
<li>Container microservice - <a href="https://github.com/ibm-cloud-architecture/refarch-kc-container-ms/tree/master/kstreams">kstreams implementation</a><br />
<code>helm install icpcontainerkstreams/ --name container-kstreams --namespace greencompute --tls</code></li>
</ul>
<h2 id="resilience">Resilience</h2>
<p>A microservice needs to be resilient to failures and to be able to restart often on another machine for availability. In the case of kafka we address, in <a href="https://ibm-cloud-architecture.github.io/refarch-eda/kafka/readme/#high-availability-in-the-context-of-kubernetes-deployment">this note</a>, the fact that we need anti-affinity rules to get brokers running on different nodes, and be sure to have at least 3 brokers running in parallel. For Zookeepers be sure to have at least 3 instances and co located with a broker. </p>
<p><img alt="" src="../es-icp-health.png" /></p>
<p>There are three stateful set defined in the deployed event streams products as illustrated below:</p>
<pre><code class="shell">$ kubectl get sts -n streams
NAME                               DESIRED   CURRENT   AGE
rolling-streams-ibm-es-elas-ad8d   2         2         40d
rolling-streams-ibm-es-kafka-sts   3         3         40d
rolling-streams-ibm-es-zook-c4c0   3         3         40d
</code></pre>

<p>Also a <code>kubectl describe nodes</code> execution will show the clear allocation of kafka pods on the 3 worker nodes"</p>
<pre><code>ExternalID:                  xxxxxxxx.170
Non-terminated Pods:         (11 in total)
Namespace             Name             CPU Requests  CPU Limits   Memory Requests  Memory Limits
---------             ----             ------------  ----------   ---------------  -------------
        0 (0%)
streams    rolling-streams-ibm-es-kafka-sts-2     1 (12%)       1 (12%)      3548Mi (11%)     3548Mi (11%)
streams    rolling-streams-ibm-es-zook-c4c0-2     100m (1%)     100m (1%)    750Mi (2%)       1Gi (3%)

ExternalID:                  xxxxxxxx.65
Non-terminated Pods:         (14 in total)

streams    rolling-streams-ibm-es-kafka-sts-1     1 (12%)       1 (12%)  3548Mi (11%)   3548Mi (11%)
streams    rolling-streams-ibm-es-zook-c4c0-1     100m (1%)     100m (1%)  750Mi (2%)     1Gi (3%)

ExternalID:                  xxxxxxx.127
Non-terminated Pods:         (14 in total)
streams    rolling-streams-ibm-es-kafka-sts-0    1 (12%)       1 (12%)     3548Mi (11%)     3548Mi (11%)
streams    rolling-streams-ibm-es-zook-c4c0-0    100m (1%)     100m (1%)   750Mi (2%)       1Gi (3%)
</code></pre>

<p>So how to ensure resiliency for consumer and producer? We are addressing in separate the discussions for <a href="https://ibm-cloud-architecture.github.io/refarch-eda/kafka/consumers/">consumer</a> and <a href="https://ibm-cloud-architecture.github.io/refarch-eda/kafka/producers/">producer</a>.</p>
<h3 id="monitoring">Monitoring</h3>
<p>There are two liveness mechanisms in kubernetes, the readiness (is the service ready to receive requests?) and the liveness (is the container running?). In case of readiness failure the service is removed from the available end points, while in case of liveness failure the container is restarted.</p>
<p>In kafka there are others things to consider. For liveness an open port responding should be fine. For readiness we want to verify if the replicas are working, or the borkers are not overloaded, and may be when there is degradation it should not accept more connections. Below is an extract of the statefulset for monitoring the kafka containers:</p>
<pre><code class="json">&quot;containers&quot;: [
          {
            &quot;name&quot;: &quot;kafka&quot;,
            &quot;livenessProbe&quot;: {
              &quot;httpGet&quot;: {
                &quot;path&quot;: &quot;/liveness&quot;,
                &quot;port&quot;: 7070,
                &quot;scheme&quot;: &quot;HTTP&quot;
              },
              &quot;initialDelaySeconds&quot;: 360,
              &quot;timeoutSeconds&quot;: 1,
              &quot;periodSeconds&quot;: 15,
              &quot;successThreshold&quot;: 1,
              &quot;failureThreshold&quot;: 3
            },
            &quot;readinessProbe&quot;: {
              &quot;httpGet&quot;: {
                &quot;path&quot;: &quot;/readiness&quot;,
                &quot;port&quot;: 7070,
                &quot;scheme&quot;: &quot;HTTP&quot;
              },
              &quot;initialDelaySeconds&quot;: 120,
              &quot;timeoutSeconds&quot;: 1,
              &quot;periodSeconds&quot;: 15,
              &quot;successThreshold&quot;: 1,
              &quot;failureThreshold&quot;: 1
            },
          }]
]

</code></pre>

<p>The REST endpoint for the health resource could look at the connection to the brokers and other internal state to assess the state of the consumers and producers and retun 503 in case of unhealthy container.</p>
<h3 id="code-considerations">Code considerations</h3>
<p>Using the following command we can assess the <code>advertiser.listerners</code> address and port number. When running local the <code>localhost:9092</code> is where the broker is listening to connetion. When deploying to kubernetes there are 3 different listeners: internal to the cluster, secured or not, and external to the cluster.</p>
<pre><code class="shell">$ cloudctl es broker-config 0 | grep listeners
advertised.listeners   INTERNAL://:9092,INTERNAL_SECURE://:8084,EXTERNAL://9.46.64.104:31244  
</code></pre>

<p>You code to be portable between IKS and ICP needs to get brokers advertiser addresses, API KEY from environment variables, and for SSL certificates use mount point and Java keystore. Easy written than done. Let go into details. </p>
<p>The API key is defined in a secret named <code>eventstreams-apikey</code> as presented <a href="#api-key">above</a>. The deployment is declaring that the <code>KAFKA_APIKEY</code> is using this secret using the following declaration:</p>
<pre><code class="yaml">- env:
    - name: KAFKA_APIKEY
        valueFrom: 
            secretKeyRef:
                name: eventstreams-apikey
                key: binding
</code></pre>

<p>As introduced in <a href="https://ibm.github.io/event-streams/getting-started/client/">this event streams note</a> the code sets the kafka properties needed to connect to the backbone. The API key is used as password for the SASL_JAAS_CONFIG, so the code gets it from the environment variables:</p>
<pre><code class="java">properties.put(SaslConfigs.SASL_JAAS_CONFIG,
        &quot;org.apache.kafka.common.security.plain.PlainLoginModule required username=\&quot;token\&quot; password=\&quot;&quot;
          + env.get(&quot;KAFKA_APIKEY&quot;) + &quot;\&quot;;&quot;);
</code></pre>

<p>Now for the CA certificates, we need to specify two environment variables: one for the truststore location and one for the truststore password and use one secret to keep the password. </p>
<pre><code class="java">    properties.put(SslConfigs.SSL_TRUSTSTORE_LOCATION_CONFIG, env.get(&quot;JKS_LOCATION&quot;));
    properties.put(SslConfigs.SSL_TRUSTSTORE_PASSWORD_CONFIG, env.get(&quot;TRUSTSTORE_PWD&quot;));
</code></pre>

<p>The environment variables are added to the Deployment yaml file.</p>
<pre><code class="yaml"> - name: JKS_LOCATION
   value: &quot;{{ .Values.eventstreams.jks_location }}&quot;
- name: TRUSTSTORE_PWD
    valueFrom: 
        secretKeyRef:
            name: truststore_pwd
            key: binding 

</code></pre>

<p>And one new secret is created, while the path to the JKS_LOCATION will be in the Liberty server folder and set in the Values.yaml. </p>
<pre><code class="shell">$ kubectl create secret generic truststore-pwd --from-literal=binding='&lt;truststore_pwd&gt;' -n greencompute
</code></pre>

<p>For the certificate itself use the TLS and CA certificates if you provided them during ICP installation, or export the self-signed public certificate (a file named <code>es-cert.jks</code>) from the Event Streams console.</p>
<p><img alt="" src="../es-icp-connection.png" />   </p>
<p>When consumers and producers are Java based, we need to keep certificate in Java Keystore. The easiest way is to modify the dockerfile to copy the cert file into a folder in the Liberty server scope (e.g. <code>liberty/wlp/usr/servers/defaultServer/resources/security</code> ) or doing it in the build script.</p>
<p>Also as the application is doing outbound call using SSL, we need to add some configuration to the server.xml, see the <a href="https://www.ibm.com/support/knowledgecenter/en/SSEQTP_liberty/com.ibm.websphere.wlp.doc/ae/twlp_config_ssl_outbound.html">product documentation on how to configure SSL outbound.</a></p>
<h3 id="troubleshouting">Troubleshouting</h3>
<p>Here is a way to assess, within the kafka container, how the message arrived on a topic:</p>
<pre><code class="shell">$ kubectl exec -ti rolling-streams-ibm-es-kafka-sts-0 -n streams bash
nobody@rolling-streams-ibm-es-kafka-sts-0 $ cd /opt/kafka/bin
nobody@rolling-streams-ibm-es-kafka-sts-0:/opt/kafka/bin$ ./kafka-console-consumer.sh --bootstrap-server rolling-streams-ibm-es-kafka-broker-svc-0.streams.svc.cluster.local:9092 --topic containers --from-beginning

&gt; {&quot;timestamp&quot;: 1554338808, &quot;type&quot;: &quot;ContainerAdded&quot;, &quot;version&quot;: &quot;1&quot;, &quot;containerID&quot;: &quot;c_0&quot;, &quot;payload&quot;: {&quot;containerID&quot;: &quot;c_0&quot;, &quot;type&quot;: &quot;Reefer&quot;, &quot;status&quot;: &quot;atDock&quot;, &quot;city&quot;: &quot;Oakland&quot;, &quot;brand&quot;: &quot;brand-reefer&quot;, &quot;capacity&quot;: 100}}
</code></pre>

<h4 id="no-resolvable-bootstrap-urls-given-in-bootstrapservers">No resolvable bootstrap urls given in bootstrap.servers</h4>
<p>It is obvious reason, but when deploying a kafka consumer or producer on Kubernetes it is important to know which name to use. As the communication will be on the overlay network we should use the internal broker name. The name will be linked to the deployed configuration of Kafka or event streams. Here are a set of commands to debug that:</p>
<pre><code class="shell"># Get the namespace name for the deployed kafka instance
$ kubectl get namespaces
&gt; ... 
&gt; streams Active &lt;x&gt;d
# Look at the name of the services of the 
$ kubectl get svc -n streams
&gt; rolling-streams-ibm-es-kafka-broker-svc-0         ClusterIP   None           &lt;none&gt;        9092/TCP,8093/TCP,9094/TCP,7070/TCP                               40d
rolling-streams-ibm-es-kafka-broker-svc-1         ClusterIP   None           &lt;none&gt;        9092/TCP,8093/TCP,9094/TCP,7070/TCP                               40d
rolling-streams-ibm-es-kafka-broker-svc-2         ClusterIP   None           &lt;none&gt;        9092/TCP,8093/TCP,9094/TCP,7070/TCP    
# Verify the name lookup with busybox... deploy busybox
$  kubectl apply -f https://k8s.io/examples/admin/dns/busybox.yaml
$  kubectl exec -ti busybox -n default -- nslookup streams
&gt; Server:    10.0.0.10
Address 1: 10.0.0.10 kube-dns.kube-system.svc.cluster.local

Name:      streams
Address 1: 10.1.12.101 indexmgr.rolling-streams-ibm-es-indexmgr-svc.streams.svc.cluster.local
Address 2: 10.1.12.102 rolling-streams-ibm-es-elas-ad8d-0.rolling-streams-ibm-es-elastic-svc.streams.svc.cluster.local
Address 3: 10.1.31.245 rolling-streams-ibm-es-elas-ad8d-1.rolling-streams-ibm-es-elastic-svc.streams.svc.cluster.local
Address 4: 10.1.12.97 10-1-12-97.rolling-streams-ibm-es-kafka-broker-svc-1.streams.svc.cluster.local
Address 5: 10.1.12.88 10-1-12-88.rolling-streams-ibm-es-zookeeper-fixed-ip-svc-1.streams.svc.cluster.local
Address 6: 10.1.193.198 10-1-193-198.rolling-streams-ibm-es-zookeeper-fixed-ip-svc-2.streams.svc.cluster.local
Address 7: 10.1.31.249 10-1-31-249.rolling-streams-ibm-es-zookeeper-fixed-ip-svc-0.streams.svc.cluster.local
Address 8: 10.0.48.98 rolling-streams-ibm-es-rest-svc.streams.svc.cluster.local
Address 9: 10.0.104.180 rolling-streams-ibm-es-rest-proxy-svc.streams.svc.cluster.local
Address 10: 10.0.9.68 rolling-streams-ibm-es-zookeeper-fixed-ip-svc-2.streams.svc.cluster.local
Address 11: 10.1.193.253 10-1-193-253.rolling-streams-ibm-es-kafka-broker-svc-2.streams.svc.cluster.local
Address 12: 10.0.187.135 rolling-streams-ibm-es-zookeeper-fixed-ip-svc-0.streams.svc.cluster.local
Address 13: 10.1.31.223 10-1-31-223.rolling-streams-ibm-es-kafka-broker-svc-0.streams.svc.cluster.local
Address 14: 10.0.33.136 rolling-streams-ibm-es-ui-svc.streams.svc.cluster.local
Address 15: 10.0.182.152 rolling-streams-ibm-es-zookeeper-fixed-ip-svc-1.streams.svc.cluster.local
Address 16: 10.0.216.177 rolling-streams-ibm-es-proxy-svc.streams.svc.cluster.local
Address 17: 10.1.12.87 10-1-12-87.rolling-streams-ibm-es-access-controller-svc.streams.svc.cluster.local
Address 18: 10.1.31.251 10-1-31-251.rolling-streams-ibm-es-access-controller-svc.streams.svc.cluster.local
</code></pre>

<p>For other DNS troubleshooting see <a href="https://kubernetes.io/docs/tasks/administer-cluster/dns-debugging-resolution/">this product note.</a></p>
<h4 id="failed-to-verify-broker-certificate-self-signed-certificate">Failed to verify broker certificate: self signed certificate</h4>
<p>When connecting a client to a deployed Kafka using the SSL protocol, there will be a SSL handcheck protocol done. The client needs to send security credentials using public keys and root certificates. The '.pem' file can be downloaded from Event stream console as <code>es-cert.pem</code>. </p>
<p><img alt="" src="../es-connection.png" /></p>
<p>The producer or consumer code needs to specify where to get the ssl certificates: Here is will be loaded from the local folder. But this file could be mounted into the docker image running the code to a folder referenced in this <code>ssl.ca.location</code>.</p>
<pre><code class="json">    'bootstrap.servers':  KAFKA_BROKERS,
    'security.protocol': 'SASL_SSL',
    'ssl.ca.location': 'es-cert.pem',
    'sasl.mechanisms': 'PLAIN',
    'sasl.username': 'token',
    'sasl.password': KAFKA_APIKEY,
</code></pre>

<h4 id="ltpa-configuration-error-unable-to-create-or-read-ltpa-key-file-optibmwlpusrserversdefaultserverresourcessecurityltpakeys">LTPA configuration error. Unable to create or read LTPA key file: /opt/ibm/wlp/usr/servers/defaultServer/resources/security/ltpa.keys</h4>
<p><TBD></p>
<p>Our how to on ICP troublshouting: https://github.com/ibm-cloud-architecture/refarch-integration/blob/master/docs/icp/troubleshooting.md</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../iks/" title="Run on IBM Cloud Kubernetes Services" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Run on IBM Cloud Kubernetes Services
              </span>
            </div>
          </a>
        
        
          <a href="../../itg-tests/" title="Integration tests" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Integration tests
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.b806dc00.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
    
  </body>
</html>